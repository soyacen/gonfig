package config

import (
	"slices"

	"github.com/soyacen/gonfig/proto/gonfig"
	"google.golang.org/protobuf/compiler/protogen"
	"google.golang.org/protobuf/proto"
)

type Generator struct {
	Plugin *protogen.Plugin
	File   *protogen.File
}

func NewGenerator(plugin *protogen.Plugin, file *protogen.File) *Generator {
	return &Generator{Plugin: plugin, File: file}
}

func (f *Generator) Generate() {
	_, ok := findFunc(f.File.Messages, func(message *protogen.Message) bool {
		return proto.HasExtension(message.Desc.Options(), gonfig.E_Enable)
	})
	if !ok {
		return
	}

	filename := f.File.GeneratedFilenamePrefix + "_gonfig.pb.go"
	g := f.Plugin.NewGeneratedFile(filename, f.File.GoImportPath)
	g.P("// Code generated by protoc-gen-gonfig. DO NOT EDIT.")
	g.P()
	g.P("package ", f.File.GoPackageName)
	g.P()

	messages := f.EnabledMessage()

	g.P("var (")
	for _, message := range messages {
		g.P(f.GlobalConfig(message), " ", Value)
	}
	g.P(")")
	g.P()

	g.P("func init() {")
	for _, message := range messages {
		g.P(f.GlobalConfig(message), ".Store(&", message.GoIdent, "{})")
	}
	g.P("}")
	g.P()

	for _, message := range messages {
		g.P("func ", f.GetConfig(message), "() *", message.GoIdent, " {")
		g.P("return ", Clone, "(", f.GlobalConfig(message), ".Load().(*", message.GoIdent, ")).(*", message.GoIdent, ")")
		g.P("}")
		g.P()
	}
	for _, message := range messages {
		g.P("func ", f.LoadConfig(message), "(ctx ", Context, ", resource ", Resource, ") error {")
		g.P("conf, err := ", Load, "[*", message.GoIdent, "](ctx, resource)")
		g.P("if err != nil {")
		g.P("return err")
		g.P("}")
		g.P(f.GlobalConfig(message), ".Store(conf)")
		g.P("return nil")
		g.P("}")
		g.P()
	}
	for _, message := range messages {
		g.P("func ", f.WatchConfig(message), "(ctx ", Context, ", resource ", Resource, ", errFunc ", ErrFunc, ") (", StopFunc, ", error) {")
		g.P("stopFunc, err :=", Watch, "[*", message.GoIdent, "](ctx, resource, func(conf *", message.GoIdent, ") { ", f.GlobalConfig(message), ".Store(conf) }, errFunc)")
		g.P("if err != nil {")
		g.P("return nil, err")
		g.P("}")
		g.P("return stopFunc, nil")
		g.P("}")
		g.P()
	}
}

func (f *Generator) Config(message *protogen.Message) string {
	return message.GoIdent.GoName + "Config"
}

func (f *Generator) GlobalConfig(message *protogen.Message) string {
	return "_" + f.Config(message)
}

func (f *Generator) GetConfig(message *protogen.Message) string {
	return "Get" + f.Config(message)
}

func (f *Generator) SetConfig(message *protogen.Message) string {
	return "Set" + f.Config(message)
}

func (f *Generator) LoadConfig(message *protogen.Message) string {
	return "Load" + f.Config(message)
}

func (f *Generator) WatchConfig(message *protogen.Message) string {
	return "Watch" + f.Config(message)
}

func (f *Generator) LoadAndWatchConfig(message *protogen.Message) string {
	return "LoadAndWatch" + f.Config(message)
}

func (f *Generator) EnabledMessage() []*protogen.Message {
	var messages []*protogen.Message
	for _, message := range f.File.Messages {
		if !proto.HasExtension(message.Desc.Options(), gonfig.E_Enable) {
			continue
		}
		if !proto.GetExtension(message.Desc.Options(), gonfig.E_Enable).(bool) {
			continue
		}
		messages = append(messages, message)
	}
	return messages
}

func findFunc[E any](s []E, f func(E) bool) (E, bool) {
	if i := slices.IndexFunc(s, f); i != -1 {
		return s[i], true
	}
	var e E
	return e, false
}

var (
	syncPackage = protogen.GoImportPath("sync")
	RWMutex     = syncPackage.Ident("RWMutex")
)

var (
	atomicPackage = protogen.GoImportPath("sync/atomic")
	Value         = atomicPackage.Ident("Value")
)

var (
	protoPackage = protogen.GoImportPath("google.golang.org/protobuf/proto")
	Clone        = protoPackage.Ident("Clone")
)

var (
	contextPackage = protogen.GoImportPath("context")
	Context        = contextPackage.Ident("Context")
)

var (
	configxPackage = protogen.GoImportPath("github.com/soyacen/gonfig")
	Load           = configxPackage.Ident("Load")
	Watch          = configxPackage.Ident("Watch")
)

var (
	resourcePackage = protogen.GoImportPath("github.com/soyacen/gonfig/resource")
	Resource        = resourcePackage.Ident("Resource")
	ErrFunc         = resourcePackage.Ident("ErrFunc")
	StopFunc        = resourcePackage.Ident("StopFunc")
)
